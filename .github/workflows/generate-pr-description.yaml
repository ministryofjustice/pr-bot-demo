name: Generate PR Description

on:
  pull_request:
    types: [opened, reopened, synchronize]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  generate:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install GitHub CLI
        run: sudo apt-get install -y gh jq

      - name: Collect commit messages
        id: commits
        run: |
          base=${{ github.event.pull_request.base.sha }}
          head=${{ github.event.pull_request.head.sha }}
          messages=$(git log --pretty=format:"%s%n%b" $base..$head)
          echo "COMMITS<<EOF" >> $GITHUB_ENV
          echo "$messages" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Check if PR body is empty
        id: bodycheck
        run: |
          branch=${GITHUB_REF#refs/heads/}
          pr_number=$(gh pr list --head "$branch" --base main --json number -q '.[0].number')
      
          if [ -z "$pr_number" ]; then
          echo "No PR found for branch $branch"
          echo "empty=false" >> $GITHUB_OUTPUT
          exit 0
          fi
      
          body=$(gh pr view "$pr_number" --json body -q '.body')
          clean=$(echo "$body" | tr -d '\n\r ')
      
          if [ -z "$clean" ] || [ "$clean" = "null" ]; then
          echo "PR #$pr_number has an empty body"
          echo "empty=true" >> $GITHUB_OUTPUT
          else
          echo "PR #$pr_number already has a body"
          echo "empty=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate description via OpenRouter
        if: steps.bodycheck.outputs.empty == 'true'
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          COMMITS: ${{ env.COMMITS }}
        run: |
          echo "Generating description..."
          prompt=$(cat <<'EOPROMPT'
          You are a release documentation assistant.
          The following are Conventional Commit messages from a pull request.
          Generate a Markdown pull request description using these sections:

          **Summary**
          A one-sentence overview of what the PR does.

          **What Changed**
          Group changes under bullet points by type (feat, fix, refactor, chore, test, docs).

          **Why**
          Explain the reasoning or problem solved.

          **Testing**
          Suggest or describe how the changes were tested.

          Use concise British English and Markdown formatting.
          EOPROMPT
          )

          response=$(curl -s https://openrouter.ai/api/v1/chat/completions \
            -H "Authorization: Bearer $OPENROUTER_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{
              \"model\": \"mistralai/mistral-7b-instruct:free\",
              \"messages\": [
                {\"role\": \"system\", \"content\": \"$prompt\"},
                {\"role\": \"user\", \"content\": \"$COMMITS\"}
              ],
              \"max_tokens\": 500
            }")

          text=$(echo "$response" | jq -r '.choices[0].message.content')
          text=$(echo "$text" | tr -d '\000-\011\013\014\016-\037' | sed 's/<[^>]*>//g; s/\[\/\?INST\]//g')

          echo "DESCRIPTION<<EOF" >> $GITHUB_ENV
          echo "$text" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Update PR body
        if: steps.bodycheck.outputs.empty == 'true'
        run: |
          gh pr edit ${{ github.event.pull_request.number }} \
            --body "${{ env.DESCRIPTION }}"
